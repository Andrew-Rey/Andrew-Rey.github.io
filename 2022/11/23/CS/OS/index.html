

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=light>



<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <!-- <link rel="dns-prefetch" href="//cdn.bootcss.com" /> -->
  <!-- <link rel="dns-prefetch" href="//cdn.mathjax.org" /> -->
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/android-chrome-192x192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
    <meta name="description" content="“This is the basic class for CS.” “And it is interesting. I mean if you can totally master it.”">
<meta property="og:type" content="article">
<meta property="og:title" content="Operating System">
<meta property="og:url" content="https://andrew-rey.github.io/2022/11/23/CS/OS/index.html">
<meta property="og:site_name" content="Andrew-Rey">
<meta property="og:description" content="“This is the basic class for CS.” “And it is interesting. I mean if you can totally master it.”">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://andrew-rey.github.io/index_imgs/os1.jpg">
<meta property="article:published_time" content="2022-11-23T11:12:45.949Z">
<meta property="article:modified_time" content="2022-11-23T11:12:45.950Z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://andrew-rey.github.io/index_imgs/os1.jpg">
  
  
  <title>Operating System - Andrew-Rey</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3696939_jf5k91uu0xi.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"andrew-rey.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":false,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.1.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>AndrewRey</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg0.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Operating System"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-23 19:12" pubdate>
          November 23, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          33k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          275 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Operating System</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on November 23, 2022 pm
                  
                
              </p>
            
            <div class="markdown-body">
              
              <p>“This is the basic class for CS.”</p>
<p>“And it is interesting. I mean if you can totally master it.”</p>
<span id="more"></span>
<h1 id="concept"><a class="markdownIt-Anchor" href="#concept"></a> Concept</h1>
<p>Framework of this chapter:</p>
<ul>
<li>basic concepts</li>
<li>OS components</li>
<li>OS services (Using components)</li>
<li>System call (how to provide services)</li>
<li>Structure</li>
<li>virtual machine</li>
</ul>
<p>These contents will be detailed written in the following chapters</p>
<h2 id="operating-system-components"><a class="markdownIt-Anchor" href="#operating-system-components"></a> Operating system components</h2>
<h3 id="process-management"><a class="markdownIt-Anchor" href="#process-management"></a> Process management</h3>
<p><strong>process</strong>: A process is a <font color=blue>program</font> in <font color=red>execution</font>.</p>
<ul>
<li>program has its own address space</li>
</ul>
<div class="note note-info">
            <h3 id="os-activities"><a class="markdownIt-Anchor" href="#os-activities"></a> OS activities:</h3><ul><li>Process creation and deletion<ul><li>using <strong>fork</strong> system call</li></ul></li><li>Process suspension and resumption (挂起或恢复)</li><li>Provision of mechanism for:<ul><li>process synchronization (进程同步)<ul><li>such as two processes should share a variable to achieve a task or job. And synchronization mechanism helps to finish this job in a proper order.</li></ul></li><li>process communication (进程通信)</li><li>deadlock handling (死锁处理)</li></ul></li></ul>
          </div>
<h3 id="main-memory-management"><a class="markdownIt-Anchor" href="#main-memory-management"></a> Main memory management</h3>
<p><strong>memory</strong>: Memory is a large array of words or bytes, each with its own address. It is a repository of quickly accessible data shared by the CPU and I/O devices.</p>
<p><strong>Main memory</strong> or <strong>primary storage</strong> is a volatile storage device (掉电易失设备).</p>
<div class="note note-info">
            <h3 id="os-activities"><a class="markdownIt-Anchor" href="#os-activities"></a> OS activities:</h3><ul><li>Keep track of which parts of memory are currently being used and by whom.</li><li>Decide which processes to load when memory space becomes available (Job scheduling, 任务调度).</li><li>Allocate and deallocate memory space as needed.</li></ul>
          </div>
<p><strong>Virtual memory</strong>: Virtual memory allows programs to address memory from a logical point of view. This technique allows applications <strong>regard</strong> that they have a continuous address space rather than fragmented spaces from main memory to disk memory.</p>
<ul>
<li>without regard to the limits of physical memory.</li>
</ul>
<h3 id="file-management"><a class="markdownIt-Anchor" href="#file-management"></a> File management</h3>
<p><strong>file</strong>: A file is a collection of related information defined by its creator. Commonly, files represent programs (both source and object form) and data.</p>
<ul>
<li>this a uniform logical view of information storage provided by OS.</li>
</ul>
<div class="note note-info">
            <h3 id="os-activities"><a class="markdownIt-Anchor" href="#os-activities"></a> OS activities:</h3><ul><li>File creation and deletion.</li><li>Directory (can be seen as a special file) creation and deletion.</li><li>Support of primitive for manipulating files and directories.</li><li>Mapping files onto secondary storage.<ul><li>for large files, how to map them onto secondary storage?</li></ul></li><li>File backup (备份) on stable (nonvolatile) storage media.</li></ul>
          </div>
<p><em>Windows file management is related to storage, but Linux not. In Linux, every thing is file, having a unified form to access files.</em></p>
<p><strong>Mount (挂载)</strong>: create a mounting point, and this file is can be accessed using mounting point.</p>
<h3 id="io-system-management"><a class="markdownIt-Anchor" href="#io-system-management"></a> I/O system management</h3>
<p>The I/O subsystem consists of:</p>
<ul>
<li>a buffer-caching system</li>
<li>a general device-driver interface (a driver is a part of OS, specific for devices)
<ul>
<li>programmed I/O</li>
<li>interrupt I/O</li>
<li>DMA</li>
</ul>
</li>
<li>drivers for specific hardware devices</li>
</ul>
<h3 id="secondary-storage-disk-management"><a class="markdownIt-Anchor" href="#secondary-storage-disk-management"></a> Secondary-storage (disk) management</h3>
<p><strong>Secondary storage</strong> is the principle on-line storage medium (线性存储介质) for both programs and data.</p>
<ul>
<li>disk</li>
<li>Main memory is volatile and too small to accommodate all data and programs permanently, so the computer must provide secondary storage to back up main memory.</li>
</ul>
<div class="note note-info">
            <h3 id="os-activities"><a class="markdownIt-Anchor" href="#os-activities"></a> OS activities;</h3><ul><li>Free space management (which parts of disk are free and how to allocate these free blocks)</li><li>Storage allocation</li><li>Disk scheduling (磁盘调度)<ul><li>磁头移动, 请求分布在不同柱面上, 相应时需要磁头在不同不同柱面上切换, 经过算法, 设计磁头移动的最短距离 (有计算题).</li></ul></li></ul>
          </div>
<h3 id="protection-system"><a class="markdownIt-Anchor" href="#protection-system"></a> Protection system</h3>
<p><strong>Protection</strong> refers to a mechanism for controlling access by programs, processes, or users to both system and user resources.</p>
<ul>
<li>distinguish between authorized and unauthorized usage.</li>
<li>specify the controls to be imposed and means for enforcement.</li>
</ul>
<p>Example:<br />
In Linux, file access control: <strong>rwx</strong>, <strong>owner</strong>, <strong>user(u)</strong>, <strong>group(g)</strong>, <strong>other(o)</strong></p>
<h3 id="command-interpreter-system"><a class="markdownIt-Anchor" href="#command-interpreter-system"></a> Command-interpreter system</h3>
<p><strong>Command-interpreter system</strong>(命令行解释系统): Interact with users, users can send instructions to OS.</p>
<ul>
<li>Shell</li>
<li>its functions is to get and execute the next command statement.</li>
</ul>
<h2 id="operating-system-services"><a class="markdownIt-Anchor" href="#operating-system-services"></a> Operating system services</h2>
<h3 id="core-operating-system-services"><a class="markdownIt-Anchor" href="#core-operating-system-services"></a> Core operating system services</h3>
<p>From the view of an user:</p>
<p><strong>Program execution</strong></p>
<ul>
<li>load a program into memory and to run it
<ul>
<li>process management, memory management, disk management and so on.</li>
</ul>
</li>
</ul>
<p><strong>I/O operations</strong></p>
<ul>
<li>user programs cannot execute I/O operations directly, the OS must provide some means to perform I/O.</li>
</ul>
<p><strong>File-system manipulation</strong></p>
<ul>
<li>programs capability to read, write, create and delete files</li>
</ul>
<p><strong>Communication</strong></p>
<ul>
<li>exchange information between processes</li>
</ul>
<p><strong>Error detection</strong></p>
<ul>
<li>ensure correct computing in CPU, memory hardware, I/O devices, user programs</li>
</ul>
<h3 id="additional-operating-system-functions"><a class="markdownIt-Anchor" href="#additional-operating-system-functions"></a> Additional operating system functions</h3>
<p>From a view of system:</p>
<p>This part is user for <strong>efficient system operations</strong>, not for helping users.</p>
<ul>
<li>Resource allocation</li>
<li>Accounting</li>
<li>Protection</li>
</ul>
<h2 id="system-call"><a class="markdownIt-Anchor" href="#system-call"></a> System call</h2>
<p>An user how to use system services:</p>
<p>Normally, we write C code and define the <code>main</code> function, this is a <em>system call</em>, but has been packaged to a convenient-to-use API.</p>
<p><strong>System call</strong> is an <strong>interface</strong> between a running program and the OS.</p>
<ul>
<li>generally available as assembly-language instructions. (汇编语言形式呈现)</li>
<li>user programs (in <strong>user mode</strong>, <code>mode bit=1</code>) send a <code>system call</code> to the OS (in <strong>kernel mode</strong>, <code>mode bit=0</code>), and the OS execute the system call, then the OS returns (and change the mode bit to 1), finally the user programs continue to execute.</li>
<li>Common in the OS</li>
<li>Some language like <code>C</code> language and <code>C++</code> are defined to replace assembly-language for system programming, which allow system call to be made directly.</li>
</ul>
<p><img src="system_call1.png" srcset="/img/loading.gif" lazyload alt="system_call1" /></p>
<h3 id="the-implementation-of-system-call"><a class="markdownIt-Anchor" href="#the-implementation-of-system-call"></a> The implementation of system call</h3>
<p>Typically, a number (index) associated with each system call.</p>
<ul>
<li>System call interface maintains a table indexed according to these numbers</li>
</ul>
<p>The system call interface invokes intended system call in OS kernel and returns status of the system call and any return values. (系统调用的接口使用OS内核中的系统调用, 并返回系统调用状态和相应参数)</p>
<p>The caller need to know <strong>nothing</strong> about how the system call in implemented.</p>
<ul>
<li>just need to <strong>obey API</strong> and understand what OS will do as a result call.</li>
<li>Most details of OS interface hidden from programmer by API
<ul>
<li>manage run-time support library <u>(set of functions built into libraries included with compiler)</u></li>
</ul>
</li>
</ul>
<p><img src="system_call2.png" srcset="/img/loading.gif" lazyload alt="system_call2" /></p>
<p>In this picture, <code>open()</code> function acts as an API, and <code>open()</code> gives a system call (in the function library) to OS (maybe in the library, <code>open()</code> function use other system functions to give a system call, because <code>open()</code> is just an <u>API</u> of system call functions). Then the OS look up this system call in its number table and then execute a specific system program (according to the index number). Finally, the OS returns the states.</p>
<h3 id="parameter-passing-in-system-call"><a class="markdownIt-Anchor" href="#parameter-passing-in-system-call"></a> Parameter passing in system call</h3>
<p>Often, more information is required than simply identity of desired system call.</p>
<p>Three types:</p>
<ul>
<li>simplest: pass the parameters in <em><strong>registers</strong></em>
<ul>
<li>maybe more parameters than registers</li>
</ul>
</li>
<li>Parameters stored in a <em><strong>block</strong></em>, or <em>table</em>, in memory. and pass the block address to registers.
<ul>
<li>taken by Linux and Solaris</li>
</ul>
</li>
<li>Parameters placed, or <u>pushed</u> onto the <em><strong>stack</strong></em> by program and <u>popped</u> off the stack by the OS.</li>
</ul>
<p><u>Block and stack don’t limit the number and the length of parameters.</u></p>
<h3 id="types-of-system-call"><a class="markdownIt-Anchor" href="#types-of-system-call"></a> Types of system call</h3>
<p>Five main types:</p>
<ul>
<li>process control</li>
<li>file management</li>
<li>device management</li>
<li>information maintenance</li>
<li>communication</li>
</ul>
<p><strong>process management</strong></p>
<center><b>Table 1: process management for major POSIX system</b></center>
<table>
<thead>
<tr>
<th>call</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pid=fork()</code></td>
<td>create a child process identical to the parent (child is same with parents process)</td>
</tr>
<tr>
<td><code>pid=waitpid(pid, &amp;statloc, options)</code></td>
<td>wait for a child to terminate</td>
</tr>
<tr>
<td><code>s=execve(name, argv, environp)</code></td>
<td>replace a process’ core image, can be used with <code>fork()</code> to let child do another things but both from parents process</td>
</tr>
<tr>
<td><code>exit(status)</code></td>
<td>terminate process execution and return status</td>
</tr>
</tbody>
</table>
<p><strong>file management</strong></p>
<center><b>Table 2: file management for major POSIX system</b></center>
<table>
<thead>
<tr>
<th>call</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fd=open(file, how, ...)</code></td>
<td>open a file for reading, writing, or both, <code>fd</code> is 文件描述符</td>
</tr>
<tr>
<td><code>s=close(fd)</code></td>
<td>close an open file</td>
</tr>
<tr>
<td><code>n=read(fd, buffer, nbytes)</code></td>
<td>read data from a file into a buffer</td>
</tr>
<tr>
<td><code>n=write(fd, buffer, nbytes)</code></td>
<td>write data from a buffer to file</td>
</tr>
<tr>
<td><code>position=lseek(fd, offset, whence)</code></td>
<td>move the file pointer</td>
</tr>
<tr>
<td><code>s=stat(name, &amp;buf)</code></td>
<td>get a file’s status information</td>
</tr>
<tr>
<td><code>mkdir()</code></td>
<td>create a new directory</td>
</tr>
<tr>
<td><code>rmdir()</code></td>
<td>remove an empty directory</td>
</tr>
<tr>
<td><code>link()</code></td>
<td>create a new entry, name2, pointing to name2. (soft link)</td>
</tr>
<tr>
<td><code>unlink()</code></td>
<td>remove the directory entry</td>
</tr>
<tr>
<td><code>mount()</code></td>
<td>mount a file system</td>
</tr>
<tr>
<td><code>unmount()</code></td>
<td>unmount a file system</td>
</tr>
</tbody>
</table>
<p><strong>miscellaneous system call</strong></p>
<table>
<thead>
<tr>
<th>call</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chdir()</code></td>
<td>change working dir</td>
</tr>
<tr>
<td><code>kill()</code></td>
<td>send a <b>signal</b> to a process</td>
</tr>
<tr>
<td><code>chmod()</code></td>
<td>change a file’s protection bits</td>
</tr>
<tr>
<td><code>time()</code></td>
<td>get the elapsed time since Jan 1, 1970</td>
</tr>
</tbody>
</table>
<h2 id="system-structure"><a class="markdownIt-Anchor" href="#system-structure"></a> System structure</h2>
<p>monolithic单体结构（一个进程）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 分层式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> 微内核结构（最核心的功能放在内核中）、模块化结构（linux）</p>
<h3 id="unix"><a class="markdownIt-Anchor" href="#unix"></a> UNIX</h3>
<p>have no concept of <strong>structure</strong>, is <strong>Single core structure.</strong></p>
<p>consists of two separable parts:</p>
<ul>
<li>system programs</li>
<li>the kernel</li>
</ul>
<h3 id="microkernel"><a class="markdownIt-Anchor" href="#microkernel"></a> Microkernel</h3>
<p>assign only a few essential functions to the kernel</p>
<ul>
<li>address spaces</li>
<li>interprocess communication (IPC)</li>
<li>basic scheduling</li>
</ul>
<div class="note note-info">
            <h3 id="benefit-and-detriments"><a class="markdownIt-Anchor" href="#benefit-and-detriments"></a> Benefit and detriments</h3><ul><li>reliable</li><li>easy to extend</li><li>secure</li><li>communication occupies much space</li></ul>
          </div>
<h3 id="modules"><a class="markdownIt-Anchor" href="#modules"></a> Modules</h3>
<p>most modern OS implement module method:</p>
<p>kernel is divided into different modules.</p>
<p>层次化不明显；可以动态对内核进行装载和删除内核模块</p>
<h2 id="virtual-machine"><a class="markdownIt-Anchor" href="#virtual-machine"></a> Virtual machine</h2>
<p>treats hardware and the OS kernel as though they were all hardware (对物理资源抽象，即抽象层，在抽象层能实现虚拟机)</p>
<p><strong>management application:</strong></p>
<ul>
<li>type 1: built on hardware
<ul>
<li>use hardware directly</li>
<li>usually used in data center or service</li>
</ul>
</li>
<li>type 2: built on the OS
<ul>
<li>lower performance (性能)</li>
<li>lower security</li>
<li>usually used on PC</li>
</ul>
</li>
</ul>
<h1 id="process"><a class="markdownIt-Anchor" href="#process"></a> Process</h1>
<h2 id="concept-of-process"><a class="markdownIt-Anchor" href="#concept-of-process"></a> Concept of process</h2>
<h3 id="what-is-a-process"><a class="markdownIt-Anchor" href="#what-is-a-process"></a> What is a process?</h3>
<ul>
<li>A program in execution</li>
<li>An instance(实例) of a program running on a computer
<ul>
<li>同样代码跑两遍，是不同的进程</li>
</ul>
</li>
<li>The entity(实体) that can be assigned to(指派) and executed on a processor</li>
<li>A unit of activity characterized by the execution of a sequence of in instructions, a current state, and an associated set of system resources(一系列指令执行，状态(如wait, execution, ready)，有资源)</li>
</ul>
<h3 id="process-in-memory"><a class="markdownIt-Anchor" href="#process-in-memory"></a> Process in memory</h3>
<ul>
<li><strong>text</strong> 代码段(<code>addr=0</code>)
<ul>
<li>code</li>
<li>codes are complied and stored here</li>
</ul>
</li>
<li><strong>data</strong> 数据段
<ul>
<li><code>global</code> data</li>
<li><code>static</code> data</li>
</ul>
</li>
<li><strong>heap</strong> 堆
<ul>
<li><code>new()</code></li>
<li><code>delete()</code></li>
</ul>
</li>
<li><strong>stack</strong> 栈(<code>addr=max</code>)
<ul>
<li>local function invoking</li>
<li>local variables calling</li>
</ul>
</li>
</ul>
<p><strong>example</strong>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">int</span> x = <span class="hljs-number">1</span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> a;<br>  <span class="hljs-type">static</span> <span class="hljs-type">int</span> b;<br>  <span class="hljs-built_in">f1</span>();<br>  <span class="hljs-type">int</span>* pointer = <span class="hljs-literal">NULL</span>;<br>  pointer = <span class="hljs-type">int</span> <span class="hljs-built_in">new</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>x</code> and <code>b</code> are in <code>data</code> sector; <code>a</code> and <code>f1()</code> are in <code>stack</code>; <code>pointer</code> points to a space of <code>heap</code>.</p>
<p>HINT: there is a <u>flexible space</u> between <strong>heap</strong> and <strong>stack</strong>.</p>
<h3 id="process-elements"><a class="markdownIt-Anchor" href="#process-elements"></a> Process elements</h3>
<ol>
<li>program code (possible shared)</li>
<li>a set of data</li>
<li>a number of attributes describing the state of the process</li>
</ol>
<h3 id="trace-of-the-process"><a class="markdownIt-Anchor" href="#trace-of-the-process"></a> Trace of the process</h3>
<p>The behavior of an individual process is shown by <strong>listing the sequence of instructions</strong> the are executed. (指令按序执行)</p>
<p>This list is called a <strong>trace</strong>.</p>
<p><strong>Dispatcher</strong> is a small program which switches the processor from one process to another. (进程切换)</p>
<h2 id="user-view-of-process"><a class="markdownIt-Anchor" href="#user-view-of-process"></a> User-view of process</h2>
<h3 id="process-creation"><a class="markdownIt-Anchor" href="#process-creation"></a> Process creation</h3>
<p>The OS builds a data structure to manage the process.</p>
<ul>
<li>
<p>Traditionally, the OS create all processes</p>
</li>
<li>
<p>But it can be useful to let a running process create another</p>
<ul>
<li>This action is called <strong>process spawning</strong> (进程派生)
<ul>
<li>Parent process is the original, creating processes</li>
<li>Child process is the new process</li>
<li>Parent process create child process, and child processes create other processes, <strong>forming a tree of process</strong>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Execution (can be set manually)</p>
<ul>
<li>parent processes and child processes execute concurrently (同时执行).</li>
<li>parents wait when children terminate</li>
</ul>
</li>
</ul>
<p>HINT: the children just copy a status of parent</p>
<table>
<thead>
<tr>
<th>command</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>fork</code></td>
<td>system call creates new <b>same</b> process</td>
</tr>
<tr>
<td><code>exec</code></td>
<td>system call used after a <code>fork</code> to replace the process’ memory space with a <b>new program</b></td>
</tr>
</tbody>
</table>
<div class="note note-info">
            <h3 id="the-differences-using-fork-in-parents-and-children-processes"><a class="markdownIt-Anchor" href="#the-differences-using-fork-in-parents-and-children-processes"></a> The differences using <code>fork()</code> in parents and children processes</h3><ol><li><p>fork返回给child_pid在两个进程中不一样. 在父进程中<code>fork()</code>的返回值大于零, 即子进程的编号; 在子进程中<code>fork()</code>的返回值是0.</p></li><li><p>可以理解为父进程在<code>fork()</code>的初期产生了子进程, 此时子进程拿到的返回值是初始化的返回值 0, 在父进程即将结束<code>fork()</code>时, 父进程拿到了被赋值的返回值. 因此在子进程中不会再次执行<code>fork()</code>, 而执行其后面的内容.</p></li><li><p>子进程不会再次执行父进程先前的内容, 只是创建时与父进程处于相同的状态.</p></li><li><p>父子进程执行的先后顺序取决于 OS 的调度</p></li></ol>
          </div>
<p><strong>example 1:</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C++">pid = fork();<br><span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>&#123;<br>  <span class="hljs-built_in">fprintf</span>(stdrr, <span class="hljs-string">&quot;fork failed&quot;</span>)<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)  <span class="hljs-comment">// child process</span><br>&#123;<br>  <span class="hljs-built_in">execlp</span>(<span class="hljs-string">&quot;/bin/ls&quot;</span>, <span class="hljs-string">&quot;ls&quot;</span>, <span class="hljs-literal">NULL</span>);  <span class="hljs-comment">// replace with a new command</span><br>&#125;<br><span class="hljs-keyword">else</span>  <span class="hljs-comment">// parent process</span><br>&#123;<br>  <span class="hljs-built_in">wait</span>(<span class="hljs-literal">NULL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;children complete&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>example 2:</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/*in file fork.c:*/</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">pid_t</span> child_pid;<br>  <br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the main program ID is %d\n&quot;</span>, (<span class="hljs-type">int</span>)<span class="hljs-built_in">getpid</span>());<br><br>  child_pid = fork();<br>  <span class="hljs-keyword">if</span> (child != <span class="hljs-number">0</span>)<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;this is the parent process, with ID is %d\n&quot;</span>, (<span class="hljs-type">int</span>)<span class="hljs-built_in">getpid</span>());<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the child&#x27;s process ID is %d\n&quot;</span>, (<span class="hljs-type">int</span>)child_pid);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;this is the child process, with ID %d\n&quot;</span>, (<span class="hljs-type">int</span>)<span class="hljs-built_in">getpid</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>And the running result is:</p>
<h3 id="process-termination"><a class="markdownIt-Anchor" href="#process-termination"></a> Process termination</h3>
<p>Process executes last statement and asks the OS to delete it. (<code>exit()</code>)</p>
<ul>
<li>Output data from child to parents (via<code>wait()</code>)</li>
<li>Process’ resources are de-allocated (收回) by the OS</li>
</ul>
<p>Parents may terminate the execution of children processes. (<code>abort()</code>)</p>
<p>Some situations of this:</p>
<ul>
<li>Child has executed allocated resources</li>
<li>Task assigned to child is non  longer required</li>
<li>Parent is exiting
<ul>
<li>OS does not allow child to continue if its parent terminates</li>
<li>Cascading termination (级联终止)</li>
<li>HINT: 父进程结束不代表子进程必须结束</li>
</ul>
</li>
</ul>
<h3 id="code-block"><a class="markdownIt-Anchor" href="#code-block"></a> Code block</h3>
<p><strong>creating process:</strong></p>
<p><code>int fork(void);</code></p>
<ul>
<li>create a new process that is exact copy of current one</li>
<li>returns process ID of new process in parent</li>
<li>return 0 is child</li>
</ul>
<p><code>int waitpid(int pid, int *stat, int opt);</code></p>
<ul>
<li>pid: process <strong>to wait for</strong>, or -1 for any</li>
<li>stat: will contain exit value, or signal</li>
<li>opt: usually 0 or WNOHANG (?what’s this)</li>
<li>return: process ID or -1 if error</li>
</ul>
<p><strong>deleting process:</strong></p>
<p><code>void exit(int status);</code></p>
<ul>
<li>current process ceases to exit</li>
<li>status shows up in waitpid(shifted)</li>
<li>by convention, status of 0 is successful, non-zero is error</li>
</ul>
<p><code>int kill(int pid, int sig);</code></p>
<ul>
<li>sends signal <code>sig</code> tp to process <code>pid</code></li>
<li><code>sig=SIGTERM</code>: most common value, kills process by default</li>
<li>application can catch ti for “cleanup”</li>
<li><code>sig=SIGKILL</code>: stronger, kills process always</li>
</ul>
<p><strong>running programs:</strong></p>
<p><code>int execve(char *prog, char **argv, char **envp);</code></p>
<p><code>int execlp(char *prog, char *arg, ...);</code></p>
<h2 id="kernel-view-of-process-using-process-control-block-pcb"><a class="markdownIt-Anchor" href="#kernel-view-of-process-using-process-control-block-pcb"></a> Kernel view of process (using Process Control Block, PCB)</h2>
<p><strong>Main problem: How to manage such many process?</strong></p>
<p>For traditional UNIX process: process is an abstraction of OS, which represents what is needed to run a program.</p>
<ul>
<li>often called a “HeavyWeightProcess”</li>
<li>while a thread is called “轻量级”</li>
</ul>
<p>This <strong>traditional</strong> process has two parts:</p>
<ol>
<li>sequential program execution stream. (now is thread)
<ol>
<li>code executed as a sequential stream of execution (thread)</li>
<li>includes states of CPU registers</li>
</ol>
</li>
<li>protected resources
<ol>
<li>main memory state</li>
<li>IO state</li>
</ol>
</li>
</ol>
<h3 id="process-elements-2"><a class="markdownIt-Anchor" href="#process-elements-2"></a> Process Elements</h3>
<ul>
<li>identifier</li>
<li>state</li>
<li>priority</li>
<li>program counter (in fact has many registers, not only the PC)</li>
<li>memory pointers</li>
<li>context data</li>
<li>IO status information</li>
<li>accounting information</li>
<li>and so on</li>
</ul>
<h3 id="implementing-process"><a class="markdownIt-Anchor" href="#implementing-process"></a> Implementing process</h3>
<p>内核如何实现一个进程? 管理一个进程?</p>
<p><strong>keep a data structure for each process</strong></p>
<ul>
<li><font color=red><b>process control block (PCB)</b></font></li>
<li>called “proc” in Unix and “task_struct” in Linux</li>
</ul>
<p><strong>track states of process</strong> ----“Process State”</p>
<ul>
<li>running, waiting, ready…</li>
</ul>
<p><strong>includes information necessary to run</strong></p>
<ul>
<li>registers, virtual memory mapping, open files…</li>
</ul>
<p><strong>Various other data about the process</strong></p>
<ul>
<li>such as user/groups…</li>
</ul>
<div class="note note-info">
            <p>PCB is also a <strong>snapshot</strong> of a process, saving all status of a process.</p>
          </div>
<h3 id="process-states"><a class="markdownIt-Anchor" href="#process-states"></a> Process states</h3>
<p><strong>new</strong>: the process is being created</p>
<p><strong>ready</strong>: the process is waiting to be assigned to a processor</p>
<p><strong>running</strong>: instructions are being executed</p>
<p><strong>waiting</strong>: the process is waiting for some event to occur</p>
<p><strong>terminated</strong>: the process has finished execution</p>
<p>The process switching graph is shown as following:</p>
<p><img src="process_state.jpg" srcset="/img/loading.gif" lazyload alt="process_state" /></p>
<p>The CPU switch from process to process:</p>
<p><img src="switch_state.jpg" srcset="/img/loading.gif" lazyload alt="state_switch" /></p>
<p>when to switch processes:</p>
<ul>
<li>interrupt</li>
<li>trap
<ul>
<li>current process running is wrong</li>
</ul>
</li>
<li>system call</li>
</ul>
<p>switch steps:</p>
<ul>
<li>save context of processor including program counter and other registers</li>
<li>update the PCB that is currently in the Running state</li>
<li>move the PCB to appropriate queue</li>
<li>select another process for execution</li>
<li>update the PCB of the process selected</li>
<li>update memory-management data structures</li>
<li>restore context of the selected process</li>
</ul>
<h3 id="process-scheduling-queues"><a class="markdownIt-Anchor" href="#process-scheduling-queues"></a> Process scheduling queues</h3>
<p><strong>Job queue</strong>: set of all processes in the system</p>
<p><strong>Ready queue</strong>: set of all processes residing in main memory, <strong>ready</strong> and waiting to execute</p>
<p><strong>Device queue</strong>: set of processes <strong>waiting</strong> for an I/O device</p>
<div class="note note-info">
            <p>Process migration between the various queue.</p>
          </div>
<p><img src="queue_switch.jpg" srcset="/img/loading.gif" lazyload alt="queue_switch" /></p>
<h3 id="scheduler"><a class="markdownIt-Anchor" href="#scheduler"></a> Scheduler</h3>
<p><strong>Long-term scheduler(Job scheduler)</strong>: select which processes should be loaded into memory for execution.</p>
<p><strong>Short-term scheduler(CPU scheduler)</strong>: selects which process should be executed next and allocates CPU</p>
<p>Short-term scheduler is invoked very frequently (milliseconds----must be fast)</p>
<p>Long-term scheduler is invoked very infrequently (seconds, minutes----may be slow)</p>
<p>The long-term scheduler controls the <em>degree of multiprogramming</em></p>
<ul>
<li>IO-bound process: spends more time doing IO than computations, many shout CPU bursts</li>
<li>CPU-bound process: spends more time doing computations, few very long CPU burst</li>
</ul>
<p>We also have <strong>Medium-term scheduler</strong></p>
<h2 id="inter-process-communication"><a class="markdownIt-Anchor" href="#inter-process-communication"></a> Inter-process communication</h2>
<h3 id="cooperating-process"><a class="markdownIt-Anchor" href="#cooperating-process"></a> Cooperating process</h3>
<p>Independent process cannot affect or be affected by the execution of another process.</p>
<p>Cooperation process can affect or be affected by the execution of another process.</p>
<div class="note note-info">
            <h3 id="advantages"><a class="markdownIt-Anchor" href="#advantages"></a> Advantages</h3><ul><li>information sharing</li><li>computation speed-up</li><li>modularity</li><li>convenience</li></ul>
          </div>
<h3 id="communication-models"><a class="markdownIt-Anchor" href="#communication-models"></a> Communication models</h3>
<p><strong>message model</strong></p>
<ul>
<li>smaller data exchange</li>
<li>inter-computer communication (跨机的通信)</li>
<li>system call with kernel</li>
</ul>
<p><strong>shared memory</strong></p>
<ul>
<li>Maximum speed/memory</li>
<li>convenience of communication</li>
<li>protection and synchronization</li>
<li>routine memory access without kernel intervention</li>
</ul>
<p><strong>Producer-Consumer Problem</strong>:<br />
Paradigm for cooperating processes, producer process produces information that is consumed by a consumer process</p>
<p><strong>POSIX shared memory example</strong></p>
<table>
<thead>
<tr>
<th>Cmd</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shmget()</code></td>
<td>A process creates a shared memory segment using this function</td>
</tr>
<tr>
<td><code>shmctl()</code></td>
<td>the original owner of a shared memory segment cna assign ownership to another user with this function</td>
</tr>
<tr>
<td><code>shmat()</code></td>
<td>Once created, a shared memory segment can be attached to a process address space using this</td>
</tr>
<tr>
<td><code>shmdt()</code></td>
<td>shared segment can be detached using this</td>
</tr>
</tbody>
</table>
<p><strong>Inter-process Communication</strong>(IPC)</p>
<p>Two operations:</p>
<ul>
<li><strong>send(message)</strong></li>
<li><strong>receive(message)</strong></li>
</ul>
<p>if P and Q wish to communicate, they need to</p>
<ul>
<li>establish a communication link between them</li>
<li>exchange messages via send/receive</li>
</ul>
<p><strong>Direct Communication</strong></p>
<ul>
<li>
<p>Processes must name each other explicitly:</p>
<ul>
<li><code>send(P, message)</code>----send a message to P</li>
<li><code>receive(Q, message)</code>----receive message from Q</li>
</ul>
</li>
<li>
<p>Properties of communication link:</p>
<ul>
<li>links are established automatically</li>
<li>a link is associated with exactly one pair of communication processes</li>
<li>between each pair processes, there exists exactly one link</li>
<li>the link may be unidirectional, but is usually bidirectional</li>
</ul>
</li>
</ul>
<p><strong>Indirect Communication</strong></p>
<ul>
<li>
<p>Operations:</p>
<ul>
<li>creates a new mailbox</li>
<li>send and receive messages through mailbox</li>
<li>destroy a mailbox</li>
</ul>
</li>
<li>
<p>Primitives are defined as:</p>
<ul>
<li><code>send(A, message)</code>----send a message to mailbox A</li>
<li><code>receive(A, message)</code>----receive a message from mail box A</li>
</ul>
</li>
<li>
<p>Problems: P1, P2 and P3 share mailbox A, P1 sends, P2 and P3 receive, who get the message?</p>
<ul>
<li>Allows a link to be associated with at most two processes</li>
<li>Allow only one process process at a time to execute s receive operation</li>
<li>Allow the system to select arbitrarily the receiver. Sender is notified who the receiver was.</li>
</ul>
</li>
</ul>
<p><strong>Synchronization</strong> Message passing may be either blocking(阻塞), or non-blocking(非阻塞)</p>
<p><strong>Buffering:</strong></p>
<ul>
<li>zero capacity</li>
<li>bounded capacity</li>
<li>unbounded capacity</li>
</ul>
<p><strong>Pipe</strong> <code>|</code> or <code>Pipe()</code>, there is a <strong>read end</strong> and a <strong>write end</strong></p>
<p><strong>Three communication methods</strong></p>
<ul>
<li>shared memory</li>
<li>pipe</li>
<li>sockets</li>
</ul>
<h1 id="threads"><a class="markdownIt-Anchor" href="#threads"></a> Threads</h1>
<h2 id="concept-2"><a class="markdownIt-Anchor" href="#concept-2"></a> Concept</h2>
<p>A <strong>thread</strong> (lightweight process, LWP) is a basic unit of CPU execution.</p>
<ul>
<li>a sequential execution stream within process</li>
</ul>
<p>A thread has a <em>thread ID</em>, a <em>program counter</em>, a <em>register set</em> and a <em>stack</em>.</p>
<p>A thread <strong>shares</strong> with each other threads in the <strong>same</strong> process <strong>its code section, data section, and other OS resources(e.g. files and signals)</strong></p>
<p><strong>Multithreading</strong>: a single program made up of a number of different concurrent activities.</p>
<h2 id="actual-thread-operations"><a class="markdownIt-Anchor" href="#actual-thread-operations"></a> Actual thread operations</h2>
<table>
<thead>
<tr>
<th>cmd</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>thread_fork(func, args)</code></td>
<td>create a new thread to run func(args)</td>
</tr>
<tr>
<td><code>thread_yield()</code></td>
<td>relinquish processor voluntarily</td>
</tr>
<tr>
<td><code>thread_join(thread)</code></td>
<td>in parent, wait for forked thread to exit, then return</td>
</tr>
<tr>
<td><code>thread_exit()</code></td>
<td>quit thread and clean up, wake up joiner if any</td>
</tr>
</tbody>
</table>
<p><strong>pThreads: POSIX standard for thread programming</strong></p>
<p><strong>thread switching faster than process switching(100 ns)</strong></p>
<h2 id="user-thread"><a class="markdownIt-Anchor" href="#user-thread"></a> User Thread</h2>
<p>thread management done by user-level thread library:<br />
e.g. POSIX Pthread, Mach C-threads, Solaris UI-threads</p>
<p>User thread are supported at the user-level, the kernel is not aware of user threads(kernel treat them as processes). A library provides all support for thread creation, termination, joining and scheduling. There is no kernel intervention and hence, <strong>user threads are more efficient.</strong> Unfortunately, since the kernel only recognizes the containing process (of the threads), <strong>if one thread is blocked, every other threads of the same process are also blocked</strong> because the containing process is blocked.</p>
<h2 id="kernel-threads"><a class="markdownIt-Anchor" href="#kernel-threads"></a> Kernel Threads</h2>
<p>Supported by the kernel. Kernel maintains context information for the process and the threads.</p>
<p>Kernel threads are directly supported by the kernel. THe kernel dose thread creation, termination, joining and scheduling in kernel space. <strong>Kernel threads are usually slower than the user threads.</strong> However, <strong>blocking one thread will not cause other threads of the same process to block.</strong> The kernel simply <strong>runs other threads</strong> In a multi-processor environment, the kernel can schedule threads on different processors.</p>
<p>The kernel has a <strong>thread table</strong> that keeps track of all the threads in the system. All calls that might block a thread are implemented as system calls. When a thread blocks, the kernel can run either another thread from the same process or a thread from a different process.</p>
<h2 id="multi-threading-models"><a class="markdownIt-Anchor" href="#multi-threading-models"></a> Multi-threading Models</h2>
<h3 id="many-to-one"><a class="markdownIt-Anchor" href="#many-to-one"></a> Many-to-one</h3>
<p>Many user-level threads mapped to single kernel thread. Used on system that do not support  kernel thread.</p>
<h3 id="one-to-one"><a class="markdownIt-Anchor" href="#one-to-one"></a> One-to-one</h3>
<p>Each user-level thread maps to kernel thread.</p>
<h3 id="many-to-many"><a class="markdownIt-Anchor" href="#many-to-many"></a> Many-to-Many</h3>
<p>Allow many user threads to be mapped to many kernel threads.</p>
<p>Allows the OS to create a sufficient number of kernel threads.</p>
<h2 id="threading-issues"><a class="markdownIt-Anchor" href="#threading-issues"></a> Threading Issues</h2>
<h3 id="semantics-of-fork-and-exec"><a class="markdownIt-Anchor" href="#semantics-of-fork-and-exec"></a> Semantics of <code>fork()</code> and <code>exec()</code></h3>
<p>Does <code>fork()</code> duplicate only the calling thread or all threads? (应该复制所有线程还是指定线程)</p>
<ul>
<li>if invoke <code>exec()</code> just after <code>fork()</code>, no need to duplicate all threads, since it is no meaning to duplicate all threads now that they will be replaced right after <code>fork()</code></li>
<li>if invoke <code>exec()</code> after <code>fork()</code> for a long time, it will duplicates all threads</li>
</ul>
<h3 id="thread-cancellation"><a class="markdownIt-Anchor" href="#thread-cancellation"></a> Thread Cancellation</h3>
<p>Terminating a thread before it has finished, two general approaches:</p>
<ul>
<li>Asynchronous cancellation (terminate thread <strong>immediately</strong>)</li>
<li>Deferred cancellation (thread check itself if it should be cancelled periodically)</li>
</ul>
<h3 id="signal-handling"><a class="markdownIt-Anchor" href="#signal-handling"></a> Signal handling</h3>
<p>Signal is used to notify a process that a particular event has occurred. All signal has same patterns:</p>
<ul>
<li>generated by particular event</li>
<li>delivered to a process</li>
<li>signal is handled</li>
</ul>
<p>A signal handler is used to process signals</p>
<div class="note note-info">
            <h3 id="options"><a class="markdownIt-Anchor" href="#options"></a> options</h3><ul><li>deliver the signal to the thread to which the signal applies</li><li>deliver the signal to every thread in the process</li><li>~ to certain threads</li><li>Assign a specific thread receive all signals for the process</li></ul>
          </div>
<h3 id="thread-pools"><a class="markdownIt-Anchor" href="#thread-pools"></a> Thread Pools</h3>
<p>Create a number of threads in a pool where they await work.</p>
<div class="note note-info">
            <h3 id="advantages"><a class="markdownIt-Anchor" href="#advantages"></a> Advantages</h3><ul><li>Usually slightly faster to service a request with an exiting thread than create a new thread.</li><li>Allows the number of threads in the application(s) to be bound to the size of pool.</li></ul>
          </div>
<h3 id="thread-specific-data"><a class="markdownIt-Anchor" href="#thread-specific-data"></a> Thread Specific Data</h3>
<p>Allows each thread to have its own <strong>copy</strong> of data</p>
<h3 id="scheduler-activations"><a class="markdownIt-Anchor" href="#scheduler-activations"></a> Scheduler Activations</h3>
<p>Both M:M and Two-level models require communication to maintain the appropriate number of kernel threads allocated to the application</p>
<p>一种解决解决用户线程库和内核间通信的方法被称为 <strong>调度器激活</strong>.</p>
<p>Scheduler activations provides <strong>upcalls</strong>, a communication mechanism from the kernel to the thread library. 上级调用用于告知用户程序特定的事件</p>
<h1 id="cpu-scheduling-important"><a class="markdownIt-Anchor" href="#cpu-scheduling-important"></a> CPU Scheduling (Important!)</h1>
<p><strong>Objective: design a scheduling algorithm for CPU. (select time point, select jobs to execute)</strong></p>
<p>Maximum CPU utilization obtained with multiprogramming</p>
<p>CPU-I/O Burst cycle: Process execution consists of a cycle of CPU execution and I/O wait.</p>
<p>Process execution repeats the CPU burst and I/O burst cycle. When a process begins an I/O burst, another process can use the CPU for a CPU burst.</p>
<div class="note note-info">
            <h3 id="cpu-io-bound"><a class="markdownIt-Anchor" href="#cpu-io-bound"></a> CPU, I/O bound</h3><ul><li>CPU bound: a process generates I/O requests infrequently, using more of its time doing computation</li><li>I/O bound: a process spends more of its time to do I/O than doing computation</li></ul>
          </div>
<p><strong>CPU Scheduler:</strong> When the CPU is idle, the OS mus select another process to run. The selected process is carried out by <strong>the short-term scheduler(CPU scheduler)</strong>. The CPU scheduler selects a process from the ready queue, and allocates the CPU resources to it. The ready queue does not have to be a FIFO one. There are many ways to organize the ready queue.</p>
<h2 id="circumstances-that-scheduling-may-take-place"><a class="markdownIt-Anchor" href="#circumstances-that-scheduling-may-take-place"></a> Circumstances that scheduling may take place</h2>
<ol>
<li>running -&gt; wait (e.g. doing for I/O)</li>
<li>running -&gt; ready (e.g. interrupt occurs)</li>
<li>wait -&gt; ready (e.g. I/O completion)</li>
<li>terminates</li>
</ol>
<p><img src="scheduler_time.png" srcset="/img/loading.gif" lazyload alt="scheduler_time" /></p>
<p><strong>Non-preemptive scheduling (非抢占式调度):</strong> scheduling occurs when a process <strong>voluntarily</strong> enters the wait state or terminates----simple, but very inefficient</p>
<p><strong>Preemptive scheduling (抢占式调度):</strong> scheduling occurs in all possible cases.</p>
<p><strong>Dispatcher:</strong> gives control of the CPU to the process selected by the short-term scheduler, involves: <em>switching context, switching to user mode, jumping to the proper location in the user program to restart that program.</em></p>
<p><strong>Dispatcher latency:</strong> time it takes for the dispatcher to stop one process and start another running</p>
<h2 id="scheduling-criteria-调度准则"><a class="markdownIt-Anchor" href="#scheduling-criteria-调度准则"></a> Scheduling Criteria (调度准则)</h2>
<p>Five common ones:</p>
<ul>
<li>CPU utilization (max)
<ul>
<li>want to keep CPU as busy as possible</li>
</ul>
</li>
<li>throughput (吞吐量) (max)
<ul>
<li>the number of processes completed per time unit</li>
<li>long processes: rate is low, short processes: rate is high</li>
</ul>
</li>
<li>turnaround time (周转时间) (min)
<ul>
<li>the time period <strong>between job submission to completion</strong></li>
<li>including:
<ul>
<li>waiting time before entering the system</li>
<li>waiting time in the ready queue</li>
<li>waiting time in all other events (e.g. I/O)</li>
<li>time the process actually running on the CPU</li>
</ul>
</li>
</ul>
</li>
<li>waiting time (min)
<ul>
<li>the sum of the periods that a process spends waiting <strong>in the ready queue.</strong> (because CPU scheduling algorithm do not affect the amount of time during which a process is waiting for I/O and other events, so we consider waiting time in ready queue only)</li>
</ul>
</li>
<li>response time (min)
<ul>
<li>the time from the submission of a request to the first response (in an interactive system).</li>
<li>do <strong>not</strong> include the time that it takes to output the response</li>
</ul>
</li>
</ul>
<h2 id="scheduling-algorithm"><a class="markdownIt-Anchor" href="#scheduling-algorithm"></a> Scheduling Algorithm</h2>
<ul>
<li>First-Come, First-Served (FCFS)</li>
<li>Shortest-Job-First (SJF)</li>
<li>Priority</li>
<li>Round-Robin</li>
<li>Multilevel Queue</li>
<li>Multilevel Feedback Queue</li>
</ul>
<h3 id="fcfs"><a class="markdownIt-Anchor" href="#fcfs"></a> FCFS</h3>
<p><strong>description</strong>: the process that requests the CPU first is allocated the CPU first</p>
<p><strong>Queue</strong></p>
<p><strong>Non-preemptive</strong>: once a process has the CPU, it will occupy the CPU until the process completes or voluntarily enters the wait state.</p>
<p><strong>Gantt Chart</strong><br />
<img src="gantt.png" srcset="/img/loading.gif" lazyload alt="gantt" /></p>
<p><strong>average waiting time</strong>: calculate</p>
<p><strong>convoy effect (护航效应)</strong>: short processes behind long processes</p>
<div class="note note-info">
            <h3 id="disadvantages"><a class="markdownIt-Anchor" href="#disadvantages"></a> disadvantages</h3><ul><li>convoy effect: all the processes wait for one big process to get off the CPU. CPU utilization may be low.</li><li>not be fair to those short ones.</li><li>troublesome for time-sharing system, where each user needs to get a share of the CPU at regular intervals.</li></ul>
          </div>
<h3 id="sjf"><a class="markdownIt-Anchor" href="#sjf"></a> SJF</h3>
<p><strong>use each process’ CPU burst length----shortest the first</strong>: when a process must be selected from the ready queue, the process with smallest next CPU burst is selected. The processes in the ready queue are sorted in CPU burst length</p>
<p><strong>if non-preemptive:</strong> once the CPU is given to the process, it cannot be preempted until completes its CPU burst</p>
<p><strong>if preemptive:</strong> if a new process arrives with less CPU burst length than <strong>remaining</strong> time of others, it will be selected immediately.</p>
<ul>
<li><strong>shortest-remaining-time-first(SRTF)</strong></li>
</ul>
<p><strong>SJF is optimal</strong>: gives minimum average waiting time for a given set of processes.</p>
<p><strong>some examples:</strong><br />
<img src="nonpree.png" srcset="/img/loading.gif" lazyload alt="nonpree" /></p>
<p><img src="pree.png" srcset="/img/loading.gif" lazyload alt="pree" /></p>
<div class="note note-info">
            <h3 id="how-to-know-the-next-cpu-burst"><a class="markdownIt-Anchor" href="#how-to-know-the-next-cpu-burst"></a> how to know the next CPU burst?</h3><p>predict: using the length of previous CPU bursts, using <strong>exponential averaging</strong></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>τ</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mi>α</mi><msub><mi>t</mi><mi>n</mi></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><msub><mi>τ</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\tau_{n+1}=\alpha t_n + (1-\alpha)\tau_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><ol><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>n</mi></msub><mo>=</mo></mrow><annotation encoding="application/x-tex">t_n=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span>actual length of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>n</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup></mrow><annotation encoding="application/x-tex">n^{th}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">h</span></span></span></span></span></span></span></span></span></span></span></span> CPU burst</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo></mrow><annotation encoding="application/x-tex">\tau_{n+1}=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.1132em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span>predicted value for the next CPU burst</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha\in[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></li></ol><p>this is a weighted equation for history data and current data</p>
          </div>
<div class="note note-info">
            <h3 id="disadvantages"><a class="markdownIt-Anchor" href="#disadvantages"></a> disadvantages</h3><ul><li>difficult to estimate the next burst time value accurately</li><li>in favor of short jobs. some long time jobs have no chance to run. (starvation)</li></ul>
          </div>
<h3 id="priority"><a class="markdownIt-Anchor" href="#priority"></a> Priority</h3>
<p>Priority may be determetered internally or externally. FCFS and SJF are the special cases of Priority.</p>
<p><strong>non-preemptive</strong></p>
<p><strong>preemptive:</strong> if the newly arrived process has higher priority, it is selected.</p>
<p>but indefinite block (or starvation) may occur: a low priority process may never have a chance to run</p>
<p><strong>method:</strong></p>
<p><strong>Aging:</strong> gradually increases the priority of processes that wait in the system for a long time. It is a technique to overcome the starvation problem.</p>
<h3 id="round-robin-rr"><a class="markdownIt-Anchor" href="#round-robin-rr"></a> Round Robin (RR)</h3>
<p>Similar to FCFS, except that each process is assigned a <strong>time quanntum</strong></p>
<ul>
<li>All processes are in the ready queue (FIFO list). When the CPU is free and lets it run for one time quantum.</li>
<li>If a process uses CPU for more than one time quantum, it is moved to the <strong>tial</strong> of the list.</li>
</ul>
<div class="note note-info">
            <h3 id="some-issues"><a class="markdownIt-Anchor" href="#some-issues"></a> Some issues</h3><ul><li>if time quantum is too large, RR reduces(退化) to FCFS</li><li>if time quantum is too small, RR becomes <strong>processor sharing</strong></li><li>context switching may affect the performance of RR, shorter time quantum means more context</li><li>turnaround time dependes on the size of time quantum</li><li>in general, 80% of the CPU burst should shorter than the time quantum</li></ul>
          </div>
<h3 id="multilevel-queue-多级队列"><a class="markdownIt-Anchor" href="#multilevel-queue-多级队列"></a> Multilevel Queue (多级队列)</h3>
<p>Ready queue is partitioned into separate queues:<br />
foreground (interactive),<br />
background (batch)</p>
<p>[ 有些进程希望保留在系统中(交互进程)，而有些进程则是后台进程，因此可以延迟执行。]</p>
<p>Each process is assigned permanently to one queue based on some properties of the process</p>
<p>Each queue has its own scheduling algorithm:</p>
<ul>
<li>foreground, interactive----RR</li>
<li>bacjground, batch----FCFS</li>
</ul>
<h4 id="hint"><a class="markdownIt-Anchor" href="#hint"></a> Hint</h4>
<p>scheduling must be done between the queue:</p>
<ul>
<li>fixed <strong>priority</strong> scheduling(i.e. serve all from foreground then from background); Possibility of starvation.</li>
<li>time quantum, each queue gets a certain amount of CPU time which it can amongst its processes</li>
</ul>
<h3 id="multilevel-feedback-queue-多级反馈队列"><a class="markdownIt-Anchor" href="#multilevel-feedback-queue-多级反馈队列"></a> Multilevel Feedback Queue (多级反馈队列)</h3>
<p>allows processes to move between queues. (can be implemented by aging)</p>
<p>if a processe uses more CPU time, it is moved to a queue of lower priority.</p>
<p>defined my the following parameters:</p>
<ul>
<li>numbers of queues</li>
<li>scheduling algorithm for each queue</li>
<li>method used to determine when to upgrade a process</li>
<li>method used to determine when to demote a process</li>
<li>method used to determine which queue process will enter whne that process needs services</li>
</ul>
<h2 id="multiple-process-scheduling"><a class="markdownIt-Anchor" href="#multiple-process-scheduling"></a> Multiple-Process scheduling</h2>
<p><em>Symmetric multiprocessing</em>–self scheduling for each processor</p>
<p><em>Affinity</em>(亲和性)–cost of cache: 当进程在 CPU 间切换时, 需要对 cache 进行重构. 需要避免 cache 重构所带来的开销</p>
<p><em>Hyperthreading</em>–logical processors seen by CPU (i.e. by setting BIOS)</p>
<h2 id="thread-scheduling"><a class="markdownIt-Anchor" href="#thread-scheduling"></a> Thread scheduling</h2>
<p><em>Local scheduling</em>–how the threads library decides which thread to put onto an available LWP</p>
<p><em>Global scheduling</em>–how the kernel decides which kernel thread to run next</p>
<h2 id="algorithm-evaluation"><a class="markdownIt-Anchor" href="#algorithm-evaluation"></a> Algorithm Evaluation</h2>
<p>no notes here.</p>
<h1 id="process-synchronization"><a class="markdownIt-Anchor" href="#process-synchronization"></a> Process Synchronization</h1>
<p>进程合作时, 几个进程之间会相互影响. 合作的进程要么会直接共享逻辑地址空间 (即代码和数据), 要么通过共享内存或信息传递的方式进行通信. 但是并发的进程对数据操作可能会导致数据的不一致, 因此需要进程间进行同步.</p>
<p>进程同步–抽象为临界区问题–提出三种解决方案 (软件方案, 硬件方案, 信号量方案)–经典同步问题–管程 (相对高级的同步结构)–补充例子</p>
<h2 id="background"><a class="markdownIt-Anchor" href="#background"></a> Background</h2>
<p>Concurrent access to shared data may result in data inconsisitency. Maintaining data consistency requires mechanisms to ensure the <strong>orderly execution</strong> of coorperating processes. Such as <em>producer-consumer problem</em> need a mechanism to ensure the order of execution.</p>
<h3 id="race-condition"><a class="markdownIt-Anchor" href="#race-condition"></a> Race Condition</h3>
<p>Race condition occurs, if:</p>
<ul>
<li>2 or more processes/threads access and manipulate the same data concurrently</li>
<li>the outcome of the execution depends on the particular order in which the access takes place.</li>
</ul>
<div class="note note-info">
            <p>to prevent race conditions, concurrent processes must be <strong>synchronized</strong></p>
          </div>
<h2 id="the-critical-section-problem-临界区问题"><a class="markdownIt-Anchor" href="#the-critical-section-problem-临界区问题"></a> the critical-section problem (临界区问题)</h2>
<p>Each process has a <strong>code segment</strong>, called <strong>critical-section</strong>, in which the shared data is accessed.</p>
<p>Problem: ensure that when one process is executing in its critical section, no other process is allowed to execute in its critical section. So it’s necessary to design a protocol that processes can use to cooperate.</p>
<p>A <strong>protocol</strong> consists of two parts: entry section and exit section. Between them is the critical section running in a mutually exclusive way.</p>
<div class="note note-info">
            <h3 id="condition-must-be-followed"><a class="markdownIt-Anchor" href="#condition-must-be-followed"></a> condition must be followed</h3><ul><li><strong>Mutual exclusion (互斥)</strong><ul><li>If there is a process exexuting in critical section, the <strong>entry protocol</strong> should be capable of blocking processes that wish to enter. And if the process in critical exits, the entry protocol must know the fact, and allows a waiting process to enter.</li></ul></li><li><strong>Progress (前进/有空让进)</strong><ul><li>If no process is executing in its critical section and some processes wish to enter critical sections, then only those processes that are waiting to enter can participate in the competition; no other process can influent the decision; this decision cannot be postponed indefinitely (不可无限推迟).</li></ul></li><li><strong>Bounded waiting (有限等待)</strong><ul><li>After a process made a request to enter its critical section and before it is granted the permission to enter, there exits a <em>bound</em> on the time to wait (it means that, a process will not wait forever to enter it critical section).</li></ul></li></ul><p>HINT:the solution to critical-section problem cannot depend on relative speed of processes and scheduling policy.</p>
          </div>
<p><em><strong>We should design a solution to satisfy the three condition.</strong></em><br />
(临界区问题需要满足以上三种条件)</p>
<p><strong>For two process condition:</strong> (Peterson algorithm, Important!)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">do</span> &#123;<br>    flag[i] = <span class="hljs-literal">true</span>;<br>    turn = j;<br>    <span class="hljs-keyword">while</span> (flag[j] == <span class="hljs-literal">true</span> &amp;&amp; turn == j);<br>    <span class="hljs-comment">// critical section</span><br>    flag[i] = <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// remainder section</span><br>&#125;<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p><em><strong>ref:<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374287625">peterson algorithm</a></strong></em></p>
<h2 id="synchronization-hardware"><a class="markdownIt-Anchor" href="#synchronization-hardware"></a> Synchronization hardware</h2>
<p>Two types: <strong>disabling enabling interrupts</strong> close interrupt if a process in critical section; <strong>Special machine instructions</strong>.</p>
<h3 id="interrupt-disabling"><a class="markdownIt-Anchor" href="#interrupt-disabling"></a> Interrupt disabling</h3>
<p>Because interrupts are disabled, no context switch will occur in a critical section. Infeasible in a multiprocessor system because all CPUs must be informed. Some features that depend on interrupts (e.g. clock) may not work properly.</p>
<h3 id="using-atomaical-instructions"><a class="markdownIt-Anchor" href="#using-atomaical-instructions"></a> Using Atomaical instructions</h3>
<p>Test and modify the content of a word <strong>atomically</strong>.</p>
<div class="note note-info">
            <p><u>atomical instructions</u> mean an instruction that can’t be devided or interrupted.</p>
          </div>
<p><strong>Test-and-Set</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// define the test and set function</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">TestAndSet</span> <span class="hljs-params">(<span class="hljs-type">bool</span> *lock)</span> </span>&#123;<br>  <span class="hljs-type">bool</span> rt = *lock;<br>  *lock = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> rt;<br>&#125;<br><span class="hljs-comment">// shared data:</span><br><span class="hljs-type">bool</span> lock = <span class="hljs-literal">false</span>;<br><span class="hljs-comment">// process P_i</span><br><span class="hljs-keyword">do</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">TestAndSet</span>(&amp;lock));<br>  <span class="hljs-comment">// critical section</span><br>  lock = <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// remainder section</span><br>&#125;<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p><em><strong>the TestAndSet() function realizes that it changes all processes’ status to enter critical section, but <u>keeps the old value of one process</u> which is going to enter critical section. <u>This function satisfies Mutual Exception rule.</u> However, this mathod not satisfies Bounded Waiting rule.</strong></em></p>
<p>Change TestAndSet to satisfy Bounded Waiting:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// enter critical section</span><br>waiting[i] = <span class="hljs-literal">true</span>;<br>key = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">while</span> (waiting[i] &amp;&amp; key) &#123;<br>  key = <span class="hljs-built_in">TestAndSet</span>(lock);<br>&#125;<br>waiting[i] = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// leave critical section</span><br>j = (i + <span class="hljs-number">1</span>) % n;<br><span class="hljs-keyword">while</span> ((j != <span class="hljs-number">1</span>) &amp;&amp; !waiting[j]) &#123;<br>  j = (j + <span class="hljs-number">1</span>) % n;<br>&#125;<br><span class="hljs-keyword">if</span> (j == i) &#123;<br>  lock = <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>  waiting[j] = <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Though this is a <em>code</em> form, but TestAndSet() is realized in hardware form.</p>
<p><strong>Swap</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Swap</span><span class="hljs-params">(<span class="hljs-type">bool</span> &amp;a, <span class="hljs-type">bool</span> &amp;b)</span> </span>&#123;<br>  <span class="hljs-type">bool</span> temp = a;<br>  a = b;<br>  b = temp;<br>&#125;<br><span class="hljs-comment">// shared data, initializaed by false</span><br><span class="hljs-type">bool</span> lock = <span class="hljs-literal">false</span>;<br><span class="hljs-comment">// local data</span><br><span class="hljs-type">bool</span> key;<br><span class="hljs-comment">// for process P_i</span><br><span class="hljs-keyword">do</span> &#123;<br>  key = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">while</span> (key == <span class="hljs-literal">true</span>)<br>    <span class="hljs-built_in">Swap</span> (key, lock);<br>  <span class="hljs-comment">// critical section</span><br>  lock = <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// remainder section</span><br>&#125;<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p>***The Swap() function will swap the value of lock and key, if ***</p>
<h2 id="semaphores-信号量-important"><a class="markdownIt-Anchor" href="#semaphores-信号量-important"></a> Semaphores (信号量, Important!)</h2>
<p>Most used~<br />
Programmer-frendly~<br />
信号量可以看作是对资源数量的衡量, 用于临界区问题时, 由于临界区只有一个, 因此信号量设置为1.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// atomic operator</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait</span><span class="hljs-params">(S)</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (S &lt;= <span class="hljs-number">0</span>);<br>  S--;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signal</span><span class="hljs-params">(S)</span> </span>&#123;<br>  S++;<br>&#125;<br><br><span class="hljs-comment">// algorithm</span><br><span class="hljs-comment">// shared data</span><br>semaphore mutex = <span class="hljs-number">1</span>;<br><span class="hljs-comment">// for process p_i</span><br><span class="hljs-keyword">do</span> &#123;<br>  <span class="hljs-built_in">wait</span>(mutex);<br>  <span class="hljs-comment">// critical section</span><br>  <span class="hljs-built_in">signal</span>(mutex);<br>  <span class="hljs-comment">// remainder section</span><br>&#125; <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p><em><strong>semaphore algorithm satisfies three rules. semaphore is like a lock. wait() lock, and signal() delock.</strong></em></p>
<p>the disadvantage is semaphore makes other processes <em>busy waiting</em>, which do nothing while waiting. for single CPU, it waste CPU resource. this is <strong>spinlock</strong>. spinlock is usually used in multi-core system, one process can enter another CPU’s critical section while one process is in now critical section.</p>
<p><em><strong>the difference waiting state:</strong></em><br />
<img src="waiting_stat.png" srcset="/img/loading.gif" lazyload alt="waiting_state" /></p>
<p><em><strong>ref:<a target="_blank" rel="noopener" href="https://blog.csdn.net/liuchuo/article/details/51986201">WaitingState</a></strong></em></p>
<p>Optimization: no busy-waiting</p>
<p>Makes one process not to busy-wait but to <strong>block itself</strong> or <strong>mounted</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// define a new semaphore</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> &#123;<br>  <span class="hljs-type">int</span> value;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">process</span> *L;  <span class="hljs-comment">// waiting process queue</span><br>&#125; semaphore;<br><br><span class="hljs-comment">// edit wait() and signal()</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait</span><span class="hljs-params">(S)</span> </span>&#123;<br>  S.value--;<br>  <span class="hljs-keyword">if</span> (S.value &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// add this process to S.L</span><br>    block;<br>  &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signal</span><span class="hljs-params">(S)</span> </span>&#123;<br>  S.value++;<br>  <span class="hljs-keyword">if</span> (S.value &lt;= <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// remove a process P from S.L</span><br>    <span class="hljs-built_in">wakeup</span>(P);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<div class="note note-info">
            <h3 id="deadlock"><a class="markdownIt-Anchor" href="#deadlock"></a> Deadlock</h3><p>two or more processes are waiting indefinitely for an event that can be caused by only one of the waiting processes.</p><h3 id="starvation"><a class="markdownIt-Anchor" href="#starvation"></a> Starvation</h3><p>indefinite blocking. A process may never be removed from the semaphore queue in which it is suspended.</p>
          </div>
<h2 id="classical-problems-of-synchronization"><a class="markdownIt-Anchor" href="#classical-problems-of-synchronization"></a> Classical problems of Synchronization</h2>
<ul>
<li>bounded-buffer problem</li>
<li>reader and writer problem</li>
<li>dining philosophers problem</li>
</ul>
<h3 id="bounded-buffer-problem"><a class="markdownIt-Anchor" href="#bounded-buffer-problem"></a> Bounded buffer problem</h3>
<p>生产者消费者问题: 存在若干生产者, 若干消费者以及一个缓冲区.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// initialization shared data</span><br>semaphore full, empty, mutex;  <span class="hljs-comment">// full and empty relize the synchronization between consumer and producer, and also represent the resource.</span><br>full = <span class="hljs-number">0</span>;  <span class="hljs-comment">// </span><br>empty = n;  <span class="hljs-comment">// initial space</span><br>mutex = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 当前临界区没有进程, 当缓冲区大小为 1 时, 可以不用此变量.</span><br><br><span class="hljs-comment">// producer process:</span><br><span class="hljs-keyword">do</span> &#123;<br>  <span class="hljs-comment">// code</span><br>  produce an item in nextp<br>  <span class="hljs-comment">// code</span><br>  <span class="hljs-built_in">wait</span>(empty);  <span class="hljs-comment">// judge if be full</span><br>  <span class="hljs-built_in">wait</span>(mutex);  <span class="hljs-comment">// buffer = 1 时, 可删</span><br>  <span class="hljs-comment">// code</span><br>  add nextp to buffer<br>  <span class="hljs-comment">// detail operation:</span><br>  buffer[in] = nextp;<br>  in = (in + <span class="hljs-number">1</span>) % bufferSize;  <span class="hljs-comment">// buffer = 1 时, 可删</span><br>  <span class="hljs-comment">// code</span><br>  <span class="hljs-built_in">signal</span>(mutex);  <span class="hljs-comment">// buffer = 1 时, 可删</span><br>  <span class="hljs-built_in">signal</span>(full);  <span class="hljs-comment">// inform</span><br>&#125; <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// consumer process</span><br><span class="hljs-keyword">do</span> &#123;<br>  <span class="hljs-built_in">wait</span>(full);<br>  <span class="hljs-built_in">wait</span>(mutex);<br>  <span class="hljs-comment">// code</span><br>  remove an item from buffer to nextc<br>  <span class="hljs-comment">// detail operation</span><br>  a = buffer[out];<br>  out = (out + <span class="hljs-number">1</span>) % bufferSize;<br>  <span class="hljs-comment">// code</span><br>  <span class="hljs-built_in">signal</span>(mutex);<br>  <span class="hljs-built_in">signal</span>(empty);<br>  <span class="hljs-comment">// code</span><br>  consume the item in nextc<br>  <span class="hljs-comment">// code</span><br>&#125; <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<h3 id="reader-writer-problem"><a class="markdownIt-Anchor" href="#reader-writer-problem"></a> Reader-Writer Problem</h3>
<p>以数据库为背景, 同时有若干的写者和读者对数据库进行操作. 写时不可读, 读时不可写. 如何权衡进程通信?</p>
<p><strong>第一读者问题:</strong> 读者可以一直读, 除非有写者正在写. 说白了就是读者优先级高于写者.</p>
<p><strong>第二读者问题:</strong> 读者优先级低于写者.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// shared data</span><br>semaphore mutex, wrt;<br><span class="hljs-type">int</span> readcount;<br><span class="hljs-comment">// initailization</span><br>mutex = <span class="hljs-number">1</span>;<br>wrt = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 表示是否可以写, 或者是写的资源</span><br>readcount = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// writer</span><br><span class="hljs-built_in">wait</span>(wrt);<br><span class="hljs-comment">// writer is writing</span><br><span class="hljs-built_in">signal</span>(wrt);<br><br><span class="hljs-comment">// reader</span><br><span class="hljs-built_in">wait</span>(mutex);  <span class="hljs-comment">// 存在并发的读者程序</span><br>readcount += <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (readcount == <span class="hljs-number">1</span>) &#123;<br>  <span class="hljs-built_in">wait</span>(wrt);  <span class="hljs-comment">// 第一个读者与写者进行权限的争抢</span><br>  <span class="hljs-comment">// 若抢到权限, 则后续读者无需再次判断, 登记读者数目后, 直接进行读的操作.</span><br>&#125;<br><span class="hljs-built_in">signal</span>(mutex);<br><span class="hljs-comment">// reader(s) are reading</span><br><span class="hljs-built_in">wait</span>(mutex);<br>readcount -= <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (readcount == <span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-built_in">signal</span>(wrt);  <span class="hljs-comment">// 最后一个读者释放对数据库操作的权限</span><br>&#125;<br><span class="hljs-built_in">signal</span>(mutex);<br></code></pre></td></tr></table></figure>
<h3 id="dining-philosophers-problem"><a class="markdownIt-Anchor" href="#dining-philosophers-problem"></a> Dining-Philosophers Problem</h3>
<p>问题描述: 有多个哲学家在一个圆桌上用餐. 相邻两人间放着 <strong>一支</strong> 筷子, 哲学家只能拿与自己相邻的筷子, 若拿到了两根筷子, 则可以用餐, 用完后放回. 但若只拿到一支筷子, 则等待另一支筷子并且不放下手中的筷子, 直到有两双筷子. 若一支也没有拿到, 则进行等待. 设计进程同步, 并防止 <strong>死锁</strong>.</p>
<p>假设有 5 个哲学家和 5 支筷子.</p>
<p><strong>Method 1(exit deadlock)</strong>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// shared data</span><br>semaphore chopsticks[<span class="hljs-number">5</span>] = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>&#125;;<br><span class="hljs-comment">// for every philosopher i:</span><br><span class="hljs-keyword">do</span> &#123;<br>  <span class="hljs-built_in">wait</span>(chopstick[i]);<br>  <span class="hljs-built_in">wait</span>(chopstick[(i + <span class="hljs-number">1</span>) % <span class="hljs-number">5</span>]);<br>  <span class="hljs-built_in">eat</span>();<br>  <span class="hljs-built_in">signal</span>(chopstick[i]);<br>  <span class="hljs-built_in">signal</span>(chopstick[(i + <span class="hljs-number">1</span>) % <span class="hljs-number">5</span>]);<br>&#125; <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p>显然, 当每个哲学家都拿左边的筷子时, 会发生死锁现象.</p>
<p><strong>Solution 1</strong>: 设置一个&quot;房间&quot;作为信号量, 房间只能一次性供四个人使用</p>
<p><strong>Solution 2</strong>: 将拿起左筷子和右边筷子 (拿一双筷子) 作为一个原子操作, 将其放入临界区.</p>
<p><strong>Solution 3</strong>: 规定奇数和偶数序号的哲学家遵守不同的拿筷子的顺序: 奇数先左后右, 偶数先右后左.</p>
<p><em><strong><a href="https://andrew-rey.github.io/2022/05/09/os-practice/">具体伪代码见操作系统习题</a></strong></em></p>
<h2 id="monitors"><a class="markdownIt-Anchor" href="#monitors"></a> Monitors</h2>
<h2 id="synchronization-example"><a class="markdownIt-Anchor" href="#synchronization-example"></a> Synchronization example</h2>
<p>后面半本书没有写博客</p>
<p>结果是最后操作系统大寄</p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CS/" class="category-chain-item">CS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Operating System</div>
      <div>https://andrew-rey.github.io/2022/11/23/CS/OS/</div>
    </div>
    <div class="license-meta">
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 23, 2022</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/12/26/Life/WinterHoliday/" title="WinterHoliday">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">WinterHoliday</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/12/Life/Code/" title="今天又是码代码的一天呢">
                        <span class="hidden-mobile">今天又是码代码的一天呢</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
